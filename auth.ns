// auth.js - –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
console.log('üöÄ Auth.js –∑–∞–≥—Ä—É–∂–µ–Ω');

const SUPABASE_URL = "https://zdmtwnvaksdbvutrpcnr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkbXR3bnZha3NkYnZ1dHJwY25yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1Mjg4NjcsImV4cCI6MjA4MzEwNDg2N30.QztruYbzPeF8CrZmT_FhMw6VHc1-289qqJ8Qs4Z7nVc";

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// –§—É–Ω–∫—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
function showScreen(screenName) {
    console.log('üñ•Ô∏è –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞:', screenName);
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
        screen.style.display = 'none';
    });
    
    const screen = document.getElementById(screenName);
    if (screen) {
        screen.style.display = 'flex';
        setTimeout(() => screen.classList.add('active'), 10);
    }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ OTP
async function sendEmailOTP() {
    const email = document.getElementById('email-input').value.trim();
    
    if (!email) {
        alert('–í–≤–µ–¥–∏—Ç–µ email');
        return;
    }
    
    try {
        console.log('üìß –û—Ç–ø—Ä–∞–≤–∫–∞ OTP –Ω–∞:', email);
        
        const { error } = await supabase.auth.signInWithOtp({
            email: email,
            options: {
                shouldCreateUser: true,
                emailRedirectTo: 'https://absgram.onrender.com'
            }
        });
        
        if (error) throw error;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –∫–æ–¥–∞
        document.querySelector('.otp-group').classList.remove('hidden');
        document.getElementById('otp-input').focus();
        
        alert('‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email.');
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
}

// –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è OTP
async function verifyEmailOTP() {
    const email = document.getElementById('email-input').value.trim();
    const token = document.getElementById('otp-input').value.trim();
    
    if (!token || token.length !== 6) {
        alert('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥');
        return;
    }
    
    try {
        const { data, error } = await supabase.auth.verifyOtp({
            email: email,
            token: token,
            type: 'email'
        });
        
        if (error) throw error;
        
        alert('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!');
        showScreen('app');
        
    } catch (error) {
        alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
    }
}

// Google OAuth
async function signInWithGoogle() {
    try {
        const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: 'https://absgram.onrender.com'
            }
        });
        
        if (error) throw error;
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ Google: ' + error.message);
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
function setupAuthHandlers() {
    console.log('üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
    
    // –ö–Ω–æ–ø–∫–∞ "–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥"
    const sendEmailBtn = document.getElementById('send-email-btn');
    if (sendEmailBtn) {
        sendEmailBtn.addEventListener('click', sendEmailOTP);
    }
    
    // –ö–Ω–æ–ø–∫–∞ "Google"
    const googleBtn = document.getElementById('google-auth-btn');
    if (googleBtn) {
        googleBtn.addEventListener('click', signInWithGoogle);
    }
    
    // –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"
    const verifyBtn = document.getElementById('verify-otp-btn');
    if (verifyBtn) {
        verifyBtn.addEventListener('click', verifyEmailOTP);
    }
    
    // Enter –≤ email –ø–æ–ª–µ
    const emailInput = document.getElementById('email-input');
    if (emailInput) {
        emailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendEmailOTP();
        });
    }
    
    // Enter –≤ OTP –ø–æ–ª–µ
    const otpInput = document.getElementById('otp-input');
    if (otpInput) {
        otpInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyEmailOTP();
        });
    }
    
    console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Auth.js –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è');
    setupAuthHandlers();
    
    // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ —Å–æ —Å–ø–ª–µ—à-—Å–∫—Ä–∏–Ω–∞
    setTimeout(() => {
        showScreen('auth');
    }, 2500);
    
    // –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
    window.sendEmailOTP = sendEmailOTP;
    window.verifyEmailOTP = verifyEmailOTP;
    window.signInWithGoogle = signInWithGoogle;
    window.showScreen = showScreen;
    
    console.log('‚úÖ Auth.js –≥–æ—Ç–æ–≤');
});

// –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∫–Ω–æ–ø–∫—É
setTimeout(() => {
    const testBtn = document.createElement('button');
    testBtn.textContent = 'üîß –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–π';
    testBtn.style.position = 'fixed';
    testBtn.style.bottom = '10px';
    testBtn.style.right = '10px';
    testBtn.style.zIndex = '9999';
    testBtn.style.padding = '10px';
    testBtn.style.background = '#4CAF50';
    testBtn.style.color = 'white';
    testBtn.style.border = 'none';
    testBtn.style.borderRadius = '5px';
    testBtn.style.cursor = 'pointer';
    
    testBtn.addEventListener('click', () => {
        console.log('=== –¢–ï–°–¢ –§–£–ù–ö–¶–ò–ô ===');
        console.log('sendEmailOTP:', typeof sendEmailOTP);
        console.log('signInWithGoogle:', typeof signInWithGoogle);
        console.log('showScreen:', typeof showScreen);
        alert('–§—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
    });
    
    document.body.appendChild(testBtn);
}, 1000);
